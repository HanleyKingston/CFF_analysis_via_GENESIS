# 5/24/20
## Generated pruned SNP list
Rscript ld_pruning.R CFF_sid_onlyGT.gds --sample_id keep_samples.rds --variant_id keep_var_stringent.rds --window_size 1

## pruned SNP list from William:
CFF_5134_onlyGT_pruned.rds
(inputs are here: https://github.com/wwgordon/cff_gwas/blob/master/ld_prune_gds.R)

# 6/4/20
## Troubleshooting PC and grm outputs - this will generate:
1. a King object
2. 1st iteration PC-Air object
3. 1st iteration PC-Relate object
4. 2nd iteration PC-Air object
5. 2nd iteration PC-Relate object
6. A kinship matrix
### Try higher relatedness threshold:
Rscript pc_grm_troubleshoot.R CFF_sid_onlyGT.gds --out_prefix high_first_kin_thresh --variant_id pruned_snps.rds --sample_id keep_samples.rds --kin_thresh1 3.5 --div_thresh1 4.5 --kin_thresh 4.5 --div_thresh 4.5 --keep_king & > high_first_kin_thresh_pc_grm_troubleshoot.out

### Pass pruned SNP object from william to generate PCs and GRM:
Rscript pc_grm_troubleshoot.R CFF_sid_onlyGT.gds --out_prefix pruned_from_William --variant_id CFF_5134_onlyGT_pruned.rds --sample_id keep_samples.rds --kin_thresh1 3.5 --div_thresh1 4.5 --kin_thresh 4.5 --div_thresh 4.5 --keep_king & > pruned_from_William_pc_grm_troubleshoot.out


## Add a shared or not shared race/ethnicity descriptor to a kinship object from King


## plots - based on the 6 outputs from above
library(ggplot2)
### Relatedness plots from king
pcrel <- readRDS(file = "high_first_kin_threshking_obj.rds")
kinship <- pcrel$kinBtwn
png("high_first_kin_thresh_king_plot.png")
ggplot(kinship, aes(IBS0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()

pcrel <- readRDS(file = "pruned_from_Williamking_1it.rds")
kinship <- pcrel$kinBtwn
png("pruned_from_William_king_plot.png")
ggplot(kinship, aes(IBS0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()

### PC visualizations from first iteration PC-Air (kin_thresh = 2^(-7/2), div_thresh = 2^(-9/2))
Rscript pca_plots.R high_first_kin_threshpcair_1it.rds --out_prefix high_first_kin_threshpcair_1it --phenotype_file annot.rds --group race_or_ethnicity

Rscript pca_plots.R pruned_from_Williampcair_1it.rds --out_prefix pruned_from_Williampcair_1it --phenotype_file annot.rds --group race_or_ethnicity

### Relatedness plots from first iteration PC-Relate
pcrel <- readRDS(file = "high_first_kin_threshpcr_obj_1it.rds")
kinship <- pcrel$kinBtwn
png("high_first_kin_thresh_kinship_1it.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()

pcrel <- readRDS(file = "pruned_from_Williampcr_obj_1it.rds")
kinship <- pcrel$kinBtwn
png("pruned_from_William_kinship_1it.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()


### PC visualizations from first iteration PC-Air (kin_thresh = 2^(-7/2), div_thresh = 2^(-9/2))
Rscript pca_plots.R high_first_kin_threshpcair.rds --out_prefix high_first_kin_threshpcair --phenotype_file annot.rds --group race_or_ethnicity

Rscript pca_plots.R pruned_from_Williampcair.rds --out_prefix pruned_from_Williampcair --phenotype_file annot.rds --group race_or_ethnicity


### Relatedness plots from 2nd iteration PC-Relate
pcrel <- readRDS(file = "high_first_kin_threshpcr_obj.rds")
kinship <- pcrel$kinBtwn
png("high_first_kin_thresh_kinship.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()

pcrel <- readRDS(file = "pruned_from_Williampcr_obj.rds")
kinship <- pcrel$kinBtwn
png("pruned_from_William_kinship.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()


## Check effect of different kin_thresh and div_thresh values on numbers in related and unrelated set - from King object
library(SeqArray)
library(GENESIS)
library(SeqVarTools)
library(SNPRelate)

## Based on my pruned SNP list:
king <- readRDS("high_first_kin_threshking_obj.rds")
kingMat <- king$kinship
colnames(kingMat) <- rownames(kingMat) <- king$sample.id
gds <- seqOpen("CFF_sid_onlyGT.gds")

### kin.thresh = 2^(-7/2), div.thresh = -2^(-9/2) *This is what I used
pc_part1 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-7/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part1)
#List of 2
# $ rels  : chr [1:4655] "S76851" "S13552" "S52656" "S54591" ...
# $ unrels: chr [1:316] "S97442" "S78938" "S77510" "S22822" ...

### kin.thresh = 2^(-7/2), div.thresh = -2^(-7/2)
pc_part2 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-7/2), div.thresh = -2^(-7/2), divobj = kingMat)
str(pc_part2)
List of 2
# $ rels  : chr [1:4655] "S76851" "S13552" "S52656" "S54591" ...
# $ unrels: chr [1:316] "S97442" "S78938" "S77510" "S22822" ...
#div.thresh does not seem to have an impact on the number of sample in related and unrelated set

### kin.thresh = 2^(-5/2), div.thresh = -2^(-9/2)
pc_part3 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-5/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part3)
#List of 2
# $ rels  : chr [1:945] "S71706" "S13731" "S38266" "S11026" ...
# $ unrels: chr [1:4026] "S66366" "S48371" "S30713" "S43109" ...

### kin.thresh = 2^(-6/2), div.thresh = -2^(-9/2)
pc_part4 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-6/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part4)
#List of 2
# $ rels  : chr [1:964] "S71706" "S35496" "S13731" "S25290" ...
# $ unrels: chr [1:4007] "S66366" "S48371" "S30713" "S43109" ...
#this is the threshold that captures everyone in the large cluster and excludes the 2 small top clusters

### kin.thresh = 2^(-6.5/2), div.thresh = -2^(-9/2)
pc_part5 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-6.5/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part5)
#List of 2
# $ rels  : chr [1:1778] "S53263" "S25472" "S32485" "S33582" ...
# $ unrels: chr [1:3193] "S66366" "S30713" "S56629" "S96954" ...


## Based on William's pruned SNP list:
king <- readRDS("pruned_from_Williamking_obj.rds")
kingMat <- king$kinship
colnames(kingMat) <- rownames(kingMat) <- king$sample.id

### kin.thresh = 2^(-7/2), div.thresh = -2^(-9/2) *This is what I used
pc_part1 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-7/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part1)
#List of 2
# $ rels  : chr [1:2254] "S53263" "S25472" "S97980" "S33582" ...
# $ unrels: chr [1:2717] "S30713" "S96954" "S38975" "S12067" ...
#Although the 2 kinship plots based on the different LD pruned objects look similar,
#there are more samples with lower kinship values in the kinship object from William's LD-pruned SNPs!


### kin.thresh = 2^(-5/2), div.thresh = -2^(-9/2)
pc_part3 <- pcairPartition(gds, kinobj = kingMat, kin.thresh = 2^(-5/2), div.thresh = -2^(-9/2), divobj = kingMat)
str(pc_part3)
List of 2
 $ rels  : chr [1:942] "S71706" "S13731" "S38266" "S87729" ...
 $ unrels: chr [1:4029] "S66366" "S48371" "S30713" "S43109" ...



## Check effect of different kin_thresh and div_thresh values on numbers in related and unrelated set from 1st iteration PC-Relate
library(GENESIS)
library(SeqVarTools)
library(SNPRelate)

## Based on my pruned SNP list:
king <- readRDS("high_first_kin_threshking_obj.rds")
kingMat <- king$kinship
colnames(kingMat) <- rownames(kingMat) <- king$sample.id
pcrel <- readRDS("high_first_kin_threshpcr_obj_1it.rds")
pcrelate_matrix <- pcrelateToMatrix(pcrel, scaleKin=1)
gds <- seqOpen("CFF_sid_onlyGT.gds")

### kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2) *This is what I used
pc_part1 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included *I looked more itno this below
str(pc_part1)
#List of 2
# $ rels  : chr [1:961] "S71706" "S13731" "S25290" "S35496" ...
# $ unrels: chr [1:4010] "S10003" "S10014" "S10074" "S10130" ...

### kin.thresh = 2^(-11/2), div.thresh = -2^(-9/2)
pc_part2 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-11/2), div.thresh = -2^(-9/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-11/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included
str(pc_part2)
#List of 2
# $ rels  : chr [1:976] "S79149" "S97265" "S40340" "S99186" ...
# $ unrels: chr [1:3995] "S10003" "S10014" "S10074" "S10130" ...

### kin.thresh = 2^(-9/2), div.thresh = -2^(-11/2)
pc_part3 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2), div.thresh = -2^(-11/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included
str(pc_part3)
#List of 2
# $ rels  : chr [1:961] "S71706" "S48216" "S38266" "S25290" ...
# $ unrels: chr [1:4010] "S10003" "S10014" "S10074" "S10130" ...
#div.thresh doesn't make a difference


## Based on pruned SNP list from William:
king <- readRDS("pruned_from_Williamking_obj.rds")
kingMat <- king$kinship
colnames(kingMat) <- rownames(kingMat) <- king$sample.id
pcrel <- readRDS("pruned_from_Williampcr_obj_1it.rds")
pcrelate_matrix <- pcrelateToMatrix(pcrel, scaleKin=1)


### kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2) *This is what I used
pc_part1 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included
str(pc_part1)
#List of 2
# $ rels  : chr [1:956] "S71706" "S11026" "S25290" "S38266" ...
# $ unrels: chr [1:4015] "S10003" "S10014" "S10074" "S10130" ...
#Number of people in unrelated set are very similar between mine and William's

### kin.thresh = 2^(-11/2), div.thresh = -2^(-9/2)
pc_part2 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-11/2), div.thresh = -2^(-9/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-11/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included
str(pc_part2)
#List of 2
# $ rels  : chr [1:974] "S40340" "S71706" "S89660" "S19246" ...
# $ unrels: chr [1:3997] "S10003" "S10014" "S10074" "S10130" ...



## Investigating warning:
#kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2) *This is what I used
pc_part1 <- pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2), div.thresh = -2^(-9/2), divobj = kingMat)
#Warning message:
#In pcairPartition(gds, kinobj = pcrelate_matrix, kin.thresh = 2^(-9/2),  :
#  some samples in unrel.set are not in kinobj or divobj; they will not be included
str(pcrelate_matrix)
#Formal class 'dsyMatrix' [package "Matrix"] with 5 slots
#  ..@ x       : num [1:24710841] 0.451885 0.000653 0.005276 0.002987 0.000796 ...
#  ..@ Dim     : int [1:2] 4971 4971
#  ..@ Dimnames:List of 2
#  .. ..$ : chr [1:4971] "S10003" "S10014" "S10017" "S10063" ...
#  .. ..$ : chr [1:4971] "S10003" "S10014" "S10017" "S10063" ...
#  ..@ uplo    : chr "U"
#  ..@ factors : list()
str(kingMat)
# num [1:4971, 1:4971] 0.5 0.0971 0.0957 0.0948 0.0926 ...
# - attr(*, "dimnames")=List of 2
#  ..$ : chr [1:4971] "S66366" "S48371" "S92611" "S30713" ...
#  ..$ : chr [1:4971] "S66366" "S48371" "S92611" "S30713" ...


# 6/5/20
## Re-run pc_grm_troubleshoot.R with the slightly lower kin_thresh (2^(-6/2)) on my SNP data
#This threshold was suggested by Stephanie to capture more individuals in the initial unrelated set
#Note, the pruned SNP list from William does 
#I am re-running the script entirely to be consistant, but this does use the same king object as the previous run
Rscript pc_grm_troubleshoot.R CFF_sid_onlyGT.gds --out_prefix kin_thresh3.0 --variant_id pruned_snps.rds --sample_id keep_samples.rds --kin_thresh1 3.0 --div_thresh1 4.5 --kin_thresh 4.5 --div_thresh 4.5 --keep_king & > kin_thresh3.0_pc_grm_troubleshoot.out


## plots
### PC visualizations from first iteration PC-Air (kin_thresh = 2^(-6/2), div_thresh = 2^(-9/2))
Rscript pca_plots.R kin_thresh3.0pcair_1it.rds --out_prefix kin_thresh3.0pcair_1it --phenotype_file annot.rds --group race_or_ethnicity

### Relatedness plots from first iteration PC-Relate
library(ggplot2)

pcrel <- readRDS(file = "kin_thresh3.0pcr_obj_1it.rds")
kinship <- pcrel$kinBtwn
png("kin_thresh3.0_kinship_1it.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()

### PC visualizations from first iteration PC-Air (kin_thresh = 2^(-9/2), div_thresh = 2^(-9/2))
Rscript pca_plots.R kin_thresh3.0pcair.rds --out_prefix kin_thresh3.0pcair --phenotype_file annot.rds --group race_or_ethnicity

### Relatedness plots from 2nd iteration PC-Relate
pcrel <- readRDS(file = "kin_thresh3.0pcr_obj.rds")
kinship <- pcrel$kinBtwn
png("kin_thresh3.0_kinship.png")
ggplot(kinship, aes(k0, kin)) +
    geom_hline(yintercept=2^(-seq(3,9,2)/2), linetype="dashed", color = "grey") +
    geom_point(alpha=0.2) +
    ylab("kinship estimate") +
    ggtitle("kinship")
dev.off()
